<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mapbox-gl-js</title>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />

    <script type="module"
        src="https://cdn.jsdelivr.net/npm/three@0.117.1/examples/jsm/controls/OrbitControls.js"></script>

    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">


    <!-- <script type="importmap">
            { "imports": {
                "RulerControl":"https://esm.run/mapbox-gl-controls"
            } }
          </script>    -->

    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css"
        type="text/css">

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <!-- <input id="search-input" type="text" placeholder="Search location"> -->
    <!-- <script type="module" src="https://cdn.jsdelivr.net//npm/mapbox-gl-controls@2.3.5/lib/InspectControl/popupTemplate.min.js"></script> -->
    <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/mapbox-gl-controls@2.3.5/lib/InspectControl/popupTemplate.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/mapbox-gl-controls@2.3.5/lib/controls.min.css" rel="stylesheet"> -->

    <script type="module">
        import {
            BackSide,
            PCFSoftShadowMap,
            MeshPhysicalMaterial,
            TextureLoader,
            Matrix4,
            AmbientLight,
            Scene,
            Camera,
            PerspectiveCamera,
            WebGLRenderer,
            Color,
            ACESFilmicToneMapping,
            sRGBEncoding,
            Mesh,
            SphereGeometry,
            MeshBasicMaterial,
            Vector3,
            DirectionalLight,
            Clock,
            Raycaster,
            FileLoader,
        } from "https://cdn.skypack.dev/three@0.137";
        import { OrbitControls } from "https://cdn.skypack.dev/three-stdlib@2.8.5/controls/OrbitControls";
        import anime from 'https://cdn.skypack.dev/animejs@3.2.1';
        import { GLTFLoader } from "https://cdn.skypack.dev/three-stdlib@2.8.5/loaders/GLTFLoader";
        import { OBJLoader } from 'https://cdn.skypack.dev/three-stdlib@2.8.5/loaders/OBJLoader'
        // import { RulerControl } from 'mapbox-gl-controls';
        // import * as mapboxGlControls from 'https://esm.run/mapbox-gl-controls';

        // mapbox token
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2Fpc2l2YXNhbmthciIsImEiOiJjbHF3OXRjdGYwMHJzMnFxcTg3d2lvcjhmIn0.HBKYuuBf6eYAbCm5ETIlCg';

        // Map Creation
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v12', // style URL
            center: [80.22697887605354, 13.078395070909325], // starting position [lng, lat]
            zoom: 17.25, // starting zoom,
            pitch: 40, // starting pitch
            bearing: -5,// starting bearing
            // hash:true,
            // keyboard:true,
            // bearingSnap:7,
            // boxZoom:true,
            attributionControl: false,


        });

        const maxZoom = map.getMaxZoom();
        console.log(maxZoom);

        const projection = map.getProjection();
        console.log(projection);

        // map.setMinZoom(2.25);
        map.setMaxZoom(19.25);
        // map.showTileBoundaries = true;

        // to view coordinates
        map.on('click', function (e) {
            var clickedCoordinates = e.lngLat;
            console.log(`'Clicked coordinates - Lon :${clickedCoordinates.lng} & Lat :${clickedCoordinates.lat}`)
        });

        // Add Attribution control to the map.
        var attributionControl = new mapboxgl.AttributionControl({
            customAttribution: 'Map design by - SIVA'
        })
        map.addControl(attributionControl);

        // Add fullScreen control to the map.
        var fullScreen = new mapboxgl.FullscreenControl({ container: document.querySelector('body') })
        map.addControl(fullScreen, 'bottom-right');

        // Add search control to the map.
        // var search = new MapboxGeocoder({
        //     accessToken: mapboxgl.accessToken,
        //     mapboxgl: mapboxgl
        // })
        // map.addControl(search, 'bottom-left');


        // Add scale control to the map.
        const scale = new mapboxgl.ScaleControl({
            maxWidth: 80,
            unit: 'imperial'
        });
        map.addControl(scale);
        scale.setUnit('metric');

        // Add nav and zoom control in MAP
        var nav = new mapboxgl.NavigationControl({
            visualizePitch: true,
            // showZoom:true,
            // showCompass:true
        });
        map.addControl(nav, 'top-right');

        // Ruler
        // map.addControl(new RulerControl(), 'top-right');
        // map.on('ruler.on', () => console.log('ruler: on'));
        // map.on('ruler.off', () => console.log('ruler: off'));

        // with miles:
        // map.addControl(new RulerControl({
        //     units: 'miles',
        //     labelFormat: n => `${n.toFixed(2)} ml`,
        // }), 'top-right');

        // Add my location control in MAP
        var geolocate = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        });
        map.addControl(geolocate, 'top-right');

        // Add Direction Control in Map
        var direction = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            styles: [
                {
                    'id': 'directions-route-line-alt',
                    'type': 'line',
                    'source': 'directions',
                    'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                    },
                    'paint': {
                        'line-color': 'gray',
                        'line-width': 4
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'LineString'],
                        ['in', 'route', 'alternate']
                    ]
                }, {
                    'id': 'directions-route-line-casing',
                    'type': 'line',
                    'source': 'directions',
                    'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                    },
                    'paint': {
                        'line-color': 'gray',
                        'line-width': 12
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'LineString'],
                        ['in', 'route', 'selected']
                    ]
                }, {
                    'id': 'directions-route-line',
                    'type': 'line',
                    'source': 'directions',
                    'layout': {
                        'line-cap': 'butt',
                        'line-join': 'round'
                    },
                    'paint': {
                        'line-color': {
                            'property': 'congestion',
                            'type': 'categorical',
                            'default': 'gray',
                            'stops': [
                                ['unknown', '#4882c5'],
                                ['low', '#4882c5'],
                                ['moderate', '#f09a46'],
                                ['heavy', '#e34341'],
                                ['severe', '#8b2342']
                            ]
                        },
                        'line-width': 7
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'LineString'],
                        ['in', 'route', 'selected']
                    ]
                }, {
                    'id': 'directions-hover-point-casing',
                    'type': 'circle',
                    'source': 'directions',
                    'paint': {
                        'circle-radius': 8,
                        'circle-color': '#fff'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'id', 'hover']
                    ]
                }, {
                    'id': 'directions-hover-point',
                    'type': 'circle',
                    'source': 'directions',
                    'paint': {
                        'circle-radius': 6,
                        'circle-color': '#3bb2d0'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'id', 'hover']
                    ]
                }, {
                    'id': 'directions-waypoint-point-casing',
                    'type': 'circle',
                    'source': 'directions',
                    'paint': {
                        'circle-radius': 8,
                        'circle-color': '#fff'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'id', 'waypoint']
                    ]
                }, {
                    'id': 'directions-waypoint-point',
                    'type': 'circle',
                    'source': 'directions',
                    'paint': {
                        'circle-radius': 6,
                        'circle-color': '#8a8bc9'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'id', 'waypoint']
                    ]
                }, {
                    'id': 'directions-origin-point',
                    'type': 'circle',
                    'source': 'directions',
                    'paint': {
                        'circle-radius': 18,
                        'circle-color': '#3bb2d0'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'marker-symbol', 'A']
                    ]
                }, {
                    'id': 'directions-origin-label',
                    'type': 'symbol',
                    'source': 'directions',
                    'layout': {
                        'text-field': 'A',
                        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                        'text-size': 12
                    },
                    'paint': {
                        'text-color': '#fff'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'marker-symbol', 'A']
                    ]
                }, {
                    'id': 'directions-destination-point',
                    'type': 'circle',
                    'source': 'directions',
                    'paint': {
                        'circle-radius': 18,
                        'circle-color': '#8a8bc9'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'marker-symbol', 'B']
                    ]
                }, {
                    'id': 'directions-destination-label',
                    'type': 'symbol',
                    'source': 'directions',
                    'layout': {
                        'text-field': 'B',
                        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                        'text-size': 12
                    },
                    'paint': {
                        'text-color': '#fff'
                    },
                    'filter': [
                        'all',
                        ['in', '$type', 'Point'],
                        ['in', 'marker-symbol', 'B']
                    ]
                }]
        })
        map.addControl(direction, 'top-left');


        // Load a 3D model (replace 'path/to/your/model.gltf' with the actual path to your 3D model file)
        // const loader = new GLTFLoader();
        // let model;

        // loader.load('assets/road/scene.gltf', (gltf) => {
        //     console.log(gltf)
        //     model = gltf.scene;
        //     model.scale.set(0.1, 0.1, 0.1);
        //     scene.add(model);
        // });

        // Create a Three.js camera
        const camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 2.5;

        // Create a WebGLRenderer
        const renderer = new WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);


        var startCoordinates = null;
        var destinationCoordinates = null;

        map.on('click', (e) => {
            // var clickedCoordinates = e.lngLat;
            // console.log(clickedCoordinates);
            if (!startCoordinates) {
                startCoordinates = e.lngLat.toArray(); // Set start coordinates on first click
            } else if (!destinationCoordinates) {
                destinationCoordinates = e.lngLat.toArray(); // Set destination coordinates on second click
                // Add a source and layer for the route line
                // map.addSource('route', {
                //     'type': 'geojson',
                //     'data': {
                //         'type': 'Feature',
                //         'properties': {},
                //         'geometry': {
                //             'type': 'LineString',
                //             'coordinates': [startCoordinates, destinationCoordinates],
                //         }
                //     }
                // });

                // map.addLayer({
                //     'id': 'route',
                //     'type': 'line',
                //     'source': 'route',
                //     'layout': {
                //         'line-join': 'round',
                //         'line-cap': 'round'
                //     },
                //     'paint': {
                //         'line-color': 'gray',
                //         'line-width': 8
                //     }
                // });

                // Display 3D model for the route
                // display3DModelAlongRoute([startCoordinates, destinationCoordinates]);

                // Request route coordinates from Mapbox Directions API
                getRouteCoordinates(startCoordinates, destinationCoordinates);
            }
        });

        async function getRouteCoordinates(start, destination) {
            // var url = 'https://api.mapbox.com/directions/v5/driving/' + start[0] + ',' + start[1] + ';' + destination[0] + ',' + destination[1] + '?geometries=geojson&steps=true&access_token=' + mapboxgl.accessToken;
            var url = `https://api.mapbox.com/directions/v5/mapbox/driving-traffic/${start[0]},${start[1]};${destination[0]},${destination[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`

            // console.log(url)
            // const demos = await fetch(url, { method: 'GET' })
            // const json = await demos.json();
            // const datas = json.routes[0];
            // console.log(datas)

            // console.log(url)
            await fetch(url, { method: 'GET' })
                .then((response) => response.json())
                .then((data) => {
                    var routeCoordinates = data.routes[0].geometry.coordinates;
                    console.log(routeCoordinates)
                    // var coords = data.routes[0].legs[0].steps.map((
                    //     step) => [step.maneuver.location.lng,
                    //     step.maneuver.location.lat])
                    // addRouteToMap(coords);
                    // showRouteDetails(data);

                    // Add a source and layer for the route line
                    // map.addSource('route', {
                    //     'type': 'geojson',
                    //     'data': {
                    //         'type': 'Feature',
                    //         'properties': {},
                    //         'geometry': {
                    //             'type': 'LineString',
                    //             'coordinates': routeCoordinates
                    //         }
                    //     }
                    // });

                    // map.addLayer({
                    //     'id': 'route',
                    //     'type': 'line',
                    //     'source': 'route',
                    //     'layout': {
                    //         'line-join': 'round',
                    //         'line-cap': 'round'
                    //     },
                    //     'paint': {
                    //         'line-color': 'gray',
                    //         'line-width': 10
                    //     }
                    // });
                    // Display 3D model for the route
                    display3DModelAlongRoute(routeCoordinates);
                }).catch(
                    function (error) {
                        console.log("An error occurred: ", error);
                    });
        }


        function display3DModelAlongRoute(routeCoordinates) {

            // Append the model to the 3D scene
            var scene = new Scene();
            // console.log(scene)
            // scene.add(model);

            // Set up a basic perspective camera
            var camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            // console.log(camera)
            camera.position.set(routeCoordinates[0][0], routeCoordinates[0][1], 1);
            // camera.position.z = 1;
            // set ambientlight

            // Renderer
            var renderer = new WebGLRenderer({antialias: true});
            renderer.shadowMap.enabled = false;
            renderer.outputEncoding = sRGBEncoding;
            renderer.toneMapping = ACESFilmicToneMapping;
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            // Controls
            var controls = new OrbitControls(camera, renderer.domElement);
            controls.update()
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            // controls.minDistance = 0.1;
            // controls.maxDistance = 5;
            controls.enableZoom = true;


            // Lights
            const ambientlight = new AmbientLight(0xffffff, 0.2);    //(color,intensity)  - light globally illuminates all objets means emitted all point in all directions
            scene.add(ambientlight);

            var loader = new OBJLoader();
            // console.log(`loaded`)
            loader.load('assets/TarRoad.obj', function (obj) {

                // Add the loaded object to the scene
                scene.add(obj);
                // console.log(glb)
                var model = obj.scene;
                model.scale.set(0.10, 0.10, 0.10); // Adjust the scale as needed
                
                // Set the model's position to the start coordinates
                model.position.set(routeCoordinates[0][0], routeCoordinates[0][1], 0);
                // var demo = model.position.set(routeCoordinates[0][0], routeCoordinates[0][1], 0);
                // console.log(demo)

                map.on('style.load', () => {
                    // Add a layer for the 3d model
                    map.addLayers({
                        "id": "3d-model",
                        "type": "custom",
                        "renderLayer": { "layerId": "3d-model" },
                        'onAdd': function (map, mbxContext) {
                            mbxContext.renderer.autoClear = false;
                            mbxContext.map = map;
                        },
                        'render': function (gl, matrix) {
                            map.triggerRepaint();

                            // Get the 3D coordinates of the model
                            var coords = map.project(routeCoordinates[0]);
                            console.log(coords)
                            coords.z = 0; // Set the elevation to 0

                            // Set the model's matrix to position it in 3D space
                            model.matrixAutoUpdate = false;
                            model.matrixWorld.makeTranslation(coords.x, coords.y, coords.z);

                            // Render the 3D model
                            mbxContext.renderer.render(scene, camera);
                        }
                        // onAdd: function () {
                        //     this.context = this.getMap().painter.getContext().gl;
                        //     this.model = model;
                        //     this.camera = new THREE.Camera();
                        //     this.scene = new THREE.Scene();
                        //     this.scene.add(this.model);
                        //     this.setupViewport();
                        // },
                        // render: function (gl, matrix) {
                        //     this.updateCameraAndViewport();
                        //     this.drawToFramebuffer(matrix);
                        // },
                        // updateCameraAndViewport: function () {
                        //     var camera = this.camera;
                        //     var viewport = this.getViewport();
                        //     var coordinate = this.getCoordinate();
                        //     var zoom = this.getMap().getZoom();
                        //     var bearing = this.getMap().transform.angle;
                        //     camera.projectionMatrix.fromMat4(viewport.projection
                        //         .glMatrix.mat4.perspective(zoom / Math.PI *
                        //             60, viewport.width / viewport.height, 1, 2
                        //         ));
                        //     camera.matrixWorld.fromArray(coordinate.toVector());
                        // },
                        // drawToFramebuffer: function (matrix) {
                        //     var gl = this.context;
                        //     gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer
                        //     );
                        //     gl.viewport(0, 0, this.width, this.height);
                        //     gl.clearColor(0, 0, 0, 0);
                        //     gl.enable(gl.DEPTH_TEST);
                        //     gl.depthMask(true);
                        //     this.renderer.state.set(this.renderer.state.
                        //         reset());
                        //     this.renderer.state.viewport(0, 0, this.width
                        //         , this.height);
                        //     this.renderer.state.scissor(0, 0, this.
                        //         width, this.height);
                        //     this.renderer.state.cullFace(false);
                        //     this.scene.autoUpdate = false;
                        //     this.scene.updateMatrixWorld();
                        //     this.layer.visible = true;
                        //     matrix && this.layer.modelMatrix.copy(matrix);
                        //     this.renderer.render(this.scene, this.camera);
                        //     this.layer.visible = false;
                        //     this.scene.autoUpdate = true;
                        // }
                    });

                })



                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
            })

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }


        // function display3DModelAlongRoute(routeCoordinates) {
        //     var loader = new GLTFLoader();
        //     loader.load('assets/road/scene.gltf', function (gltf) {
        //         console.log(gltf)
        //         var model = gltf.scene;
        //         console.log(model)
        //         model.scale.set(0.1, 0.1, 0.1); // Adjust the scale as needed

        //         // Create a LineString feature for the route
        //         var routeFeature = {
        //             'type': 'Feature',
        //             'properties': {},
        //             'geometry': {
        //                 'type': 'LineString',
        //                 'coordinates': routeCoordinates
        //             }
        //         };


        //         // Add the route feature to the map
        //         map.getSource('route').setData(routeFeature);

        //         // Set the model's position to the start coordinates
        //         model.position.set(routeCoordinates[0][0], routeCoordinates[0][1], 0);
        //         // Add the model to the scene
        //         map.on('style.load', function () {
        //             map.addLayer({
        //                 'id': '3d-model',
        //                 'type': 'custom',
        //                 'renderingMode': '3d',
        //                 'onAdd': function (map, mbxContext) {
        //                     mbxContext.renderer.autoClear = false;
        //                 },
        //                 'render': function (gl, matrix) {
        //                     map.triggerRepaint();
        //                 }
        //             });
        //         });


        //     });

        //     // Create a Three.js scene
        //     const scene = new Scene();
        //     scene.add(model);

        // function animate() {
        //     requestAnimationFrame(animate);
        //     renderer.render(scene, camera);
        // }
        // animate();

        // }

    </script>
</body>

</html>